<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" type="image/png" sizes="32x32" href="favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="favicon-16x16.png">
    <link rel="stylesheet" href="css/main.css">
    <title>Joey's Homepage - Private Journal</title>

<style>
    /* Import your existing variables and styling */
    @import url('https://fonts.googleapis.com/css2?family=Fira+Code&display=swap');
    
    body {
        margin: 0;
        padding-top: 50px;
        transition: padding-top 0.3s ease;
        background-color: var(--primary-background-color, #1C1C1C);
        color: var(--primary-font-color, #FFFFFC);
        font-family: "Fira Code", ui-monospace, SFMono-Regular, SF Mono, Menlo, Consolas, Liberation Mono, monospace;
        font-size: 1rem;
        line-height: 1.5;
    }

    body.alert-active {
        padding-top: 105px;
    }

    /* Header elements - matching your existing site */
    #weather-alert {
        display: none;
        background-color: #d9534f;
        color: white;
        padding: 15px;
        text-align: center;
        font-size: 18px;
        font-weight: lighter;
        position: fixed;
        top: 0;
        width: 100%;
        z-index: 10000;
        border-bottom: 2px solid #a94442;
        height: 55px;
        box-sizing: border-box;
    }

    #news-ticker {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 50px;
        background: #000;
        color: #fff;
        overflow: hidden;
        z-index: 9999;
        border-bottom: 2px solid #333;
        transition: top 0.3s ease;
    }

    body.alert-active #news-ticker {
        top: 55px;
    }

    #news-content {
        position: absolute;
        white-space: nowrap;
        line-height: 50px;
        font-size: 16px;
        font-weight: lighter;
        animation-name: scroll-left;
        animation-duration: 100s;
        animation-timing-function: linear;
        animation-iteration-count: infinite;
        will-change: transform;
    }

    @keyframes scroll-left {
        0% { transform: translateX(100vw); }
        100% { transform: translateX(-100%); }
    }

    #news-content a {
        color: #fff;
        text-decoration: none;
        margin-right: 80px;
    }

    #news-content a:hover {
        text-decoration: underline;
    }

    /* Main content styling */
    main {
        position: relative;
        top: 10px;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        min-height: calc(100vh - 120px);
        padding: 2rem 1rem;
    }

    .journal-container {
        background: rgba(255, 255, 255, 0.05);
        backdrop-filter: blur(10px);
        border-radius: 0.5rem;
        padding: 2rem;
        width: 100%;
        max-width: 45rem;
        border: 0.125rem solid rgba(255, 255, 255, 0.15);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
    }

    h1 {
        text-align: center;
        color: #F05E1C;
        margin-bottom: 2rem;
        font-size: 2rem;
        font-weight: 400;
    }

    .login-section {
        text-align: center;
        margin-bottom: 2rem;
    }

    .journal-section {
        display: none;
    }

    .input-group {
        margin-bottom: 1.5rem;
    }

    label {
        display: block;
        margin-bottom: 0.5rem;
        color: var(--primary-link-color, rgba(255, 255, 252, 0.75));
        font-weight: 500;
    }

    input[type="password"], input[type="text"], textarea {
        width: 100%;
        padding: 1rem;
        border: 0.125rem solid rgba(255, 255, 255, 0.25);
        border-radius: 0.5rem;
        font-size: 1rem;
        background-color: rgba(255, 255, 255, 0.05);
        color: var(--primary-font-color, #FFFFFC);
        font-family: inherit;
        transition: all 0.125s ease-in-out;
        box-sizing: border-box;
    }

    input[type="password"]:focus, input[type="text"]:focus, textarea:focus {
        outline: 0.25rem solid rgba(240, 94, 28, 0.25);
        border-color: #F05E1C;
        background-color: rgba(255, 255, 252, 0.025);
    }

    textarea {
        min-height: 15rem;
        resize: vertical;
        line-height: 1.6;
    }

    .btn {
        background-color: #F05E1C;
        color: white;
        border: none;
        padding: 1rem 2rem;
        border-radius: 0.5rem;
        font-size: 1rem;
        cursor: pointer;
        font-family: inherit;
        font-weight: 500;
        transition: all 0.125s ease-in-out;
        margin: 0.5rem;
    }

    .btn:hover {
        background-color: rgba(240, 94, 28, 0.8);
        transform: translateY(-1px);
    }

    .btn:active {
        transform: translateY(0);
    }

    .btn:disabled {
        background-color: #666;
        cursor: not-allowed;
        transform: none;
    }

    .btn-secondary {
        background-color: rgba(255, 255, 255, 0.1);
        border: 0.125rem solid rgba(255, 255, 255, 0.25);
    }

    .btn-secondary:hover {
        background-color: rgba(255, 255, 255, 0.15);
    }

    .error-message {
        color: #ff6b6b;
        background-color: rgba(255, 107, 107, 0.1);
        border: 0.125rem solid rgba(255, 107, 107, 0.3);
        padding: 1rem;
        border-radius: 0.5rem;
        margin: 1rem 0;
        text-align: center;
    }

    .success-message {
        color: #51cf66;
        background-color: rgba(81, 207, 102, 0.1);
        border: 0.125rem solid rgba(81, 207, 102, 0.3);
        padding: 1rem;
        border-radius: 0.5rem;
        margin: 1rem 0;
        text-align: center;
    }

    .info-message {
        color: #74c0fc;
        background-color: rgba(116, 192, 252, 0.1);
        border: 0.125rem solid rgba(116, 192, 252, 0.3);
        padding: 1rem;
        border-radius: 0.5rem;
        margin: 1rem 0;
        text-align: center;
    }

    .home-link {
        position: absolute;
        top: 1rem;
        right: 1rem;
        color: var(--primary-link-color, rgba(255, 255, 252, 0.75));
        text-decoration: none;
        font-size: 0.9rem;
        padding: 0.5rem 1rem;
        border: 0.125rem solid rgba(255, 255, 255, 0.25);
        border-radius: 0.25rem;
        transition: all 0.125s ease-in-out;
    }

    .home-link:hover {
        color: #FFFFFC;
        background-color: rgba(255, 255, 255, 0.05);
        border-color: rgba(255, 255, 255, 0.5);
    }

    /* Footer - matching your existing site */
    #network-info {
        position: fixed;
        bottom: 0;
        width: 100%;
        display: flex;
        justify-content: space-around;
        padding: 10px;
        background: rgba(0,0,0,0.5);
        color: white;
        font-size: 14px;
        z-index: 1000;
    }

    /* Dark/Light mode variables */
    :root {
        --color-black-hsl: 0 0% 11%;
        --color-black: hsl(var(--color-black-hsl));
        --color-orange-hsl: 19 88% 53%;
        --color-orange: hsl(var(--color-orange-hsl));
        --color-white-hsl: 60 100% 99%;
        --color-white: hsl(var(--color-white-hsl));
    }

    @media (prefers-color-scheme: dark) {
        :root {
            --primary-background-color: var(--color-black);
            --primary-font-color: var(--color-white);
            --primary-link-color: hsl(var(--color-white-hsl) / 0.5);
            --primary-link-hover-color: var(--color-white);
        }
    }

    @media (prefers-color-scheme: light) {
        :root {
            --primary-background-color: hsl(var(--color-black-hsl) / 0.075);
            --primary-font-color: hsl(var(--color-black-hsl) / 0.75);
            --primary-link-color: hsl(var(--color-black-hsl) / 0.75);
            --primary-link-hover-color: var(--color-black);
        }
        
        body {
            background-color: hsl(var(--color-black-hsl) / 0.075);
            color: hsl(var(--color-black-hsl) / 0.75);
        }
        
        .journal-container {
            background: rgba(0, 0, 0, 0.05);
            border-color: rgba(0, 0, 0, 0.15);
        }
        
        input[type="password"], input[type="text"], textarea {
            background-color: rgba(0, 0, 0, 0.05);
            border-color: rgba(0, 0, 0, 0.25);
            color: hsl(var(--color-black-hsl) / 0.75);
        }
    }

    @media screen and (max-width: 48em) {
        .journal-container {
            padding: 1rem;
            margin: 1rem;
        }
        
        h1 {
            font-size: 1.5rem;
        }
    }
</style>
</head>
<body>
    <div id="weather-alert"></div>
    
    <div id="news-ticker">
        <div id="news-content">üî¥ Loading RSS News Feed......</div>
    </div>

    <main>
        <div class="journal-container">
            <a href="index.html" class="home-link">‚Üê Home</a>
            
            <h1>Private Journal</h1>

            <div id="login-section" class="login-section">
                <div class="input-group">
                    <label for="password-input">Enter Password:</label>
                    <input type="password" id="password-input" placeholder="Your journal password">
                </div>
                <button id="login-btn" class="btn">Access Journal</button>
                <div id="login-error" class="error-message" style="display: none;"></div>
            </div>

            <div id="journal-section" class="journal-section">
                <div class="input-group">
                    <label for="entry-title">Entry Title (optional):</label>
                    <input type="text" id="entry-title" placeholder="Today's thoughts...">
                </div>
                
                <div class="input-group">
                    <label for="journal-entry">Journal Entry:</label>
                    <textarea id="journal-entry" placeholder="Write your thoughts here..."></textarea>
                </div>
                
                <div style="text-align: center;">
                    <button id="save-btn" class="btn">Save to Google Drive</button>
                    <button id="save-local-btn" class="btn">Download as Text File</button>
                    <button id="clear-btn" class="btn btn-secondary">Clear Entry</button>
                    <button id="logout-btn" class="btn btn-secondary">Logout</button>
                </div>
                
                <div id="save-status" style="display: none;"></div>
            </div>
        </div>
    </main>

    <footer id="network-info">
        <div id="ip-info">IP: Loading...</div>
        <div id="location-info">Location: Loading...</div>
        <div id="asn-info">ASN: Loading...</div>
        <div id="organization-info">Organization: Loading...</div>
        <div id="speed-test">Speed: Loading...</div>
    </footer>

    <script src="https://apis.google.com/js/api.js"></script>
    <script src="https://accounts.google.com/gsi/client" async defer></script>

    <script>
        // Configuration - Your credentials
        const GOOGLE_CONFIG = {
            apiKey: 'AIzaSyC55-oJVpJsjIv3Ek7ZuZSEyzD_TM-Uicg',
            clientId: '702473947655-cs6448880982v51cpml7enc1k9ih04sn.apps.googleusercontent.com',
            scope: 'https://www.googleapis.com/auth/drive.file'
        };

        // Password hashing and security
        async function hashPassword(password) {
            const encoder = new TextEncoder();
            const data = encoder.encode(password + 'journal_salt_2024'); // Add salt
            const hash = await crypto.subtle.digest('SHA-256', data);
            return Array.from(new Uint8Array(hash))
                .map(b => b.toString(16).padStart(2, '0'))
                .join('');
        }

        // Store the hashed password
        const STORED_PASSWORD_HASH = '52d160c99f47dfb7b1ad082658d9feea951f16107f58e3fe5d3dd188c3013434';

        // Google Drive integration variables
        let tokenClient;

        // Initialize Google APIs
        function initializeGoogleAPIs() {
            gapi.load('client', async () => {
                await gapi.client.init({
                    apiKey: GOOGLE_CONFIG.apiKey,
                    discoveryDocs: ['https://www.googleapis.com/discovery/v1/apis/drive/v3/rest'],
                });
            });

            tokenClient = google.accounts.oauth2.initTokenClient({
                client_id: GOOGLE_CONFIG.clientId,
                scope: GOOGLE_CONFIG.scope,
                callback: (tokenResponse) => {
                    console.log('Access token received:', tokenResponse.access_token);
                },
            });
        }

        // Login functionality
        document.getElementById('login-btn').addEventListener('click', async function() {
            const passwordInput = document.getElementById('password-input');
            const password = passwordInput.value;
            
            if (!password) {
                showError('Please enter a password');
                return;
            }

            const hashedInput = await hashPassword(password);
            
            if (hashedInput === STORED_PASSWORD_HASH) {
                document.getElementById('login-section').style.display = 'none';
                document.getElementById('journal-section').style.display = 'block';
                passwordInput.value = '';
                
                initializeGoogleAPIs();
            } else {
                showError('Incorrect password');
                passwordInput.value = '';
            }
        });

        // Allow Enter key for login
        document.getElementById('password-input').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                document.getElementById('login-btn').click();
            }
        });

        // Logout functionality
        document.getElementById('logout-btn').addEventListener('click', function() {
            document.getElementById('journal-section').style.display = 'none';
            document.getElementById('login-section').style.display = 'block';
            document.getElementById('journal-entry').value = '';
            document.getElementById('entry-title').value = '';
            hideMessages();
        });

        // Clear entry functionality
        document.getElementById('clear-btn').addEventListener('click', function() {
            if (confirm('Are you sure you want to clear this entry?')) {
                document.getElementById('journal-entry').value = '';
                document.getElementById('entry-title').value = '';
            }
        });
        
        // NEW: Function to get or create the "Journal Entries" folder
        async function getOrCreateFolderId() {
            let folderId = null;

            // Search for the folder
            const response = await gapi.client.drive.files.list({
                q: "mimeType='application/vnd.google-apps.folder' and name='Journal Entries' and trashed=false",
                fields: 'files(id, name)',
            });

            if (response.result.files.length > 0) {
                // Folder found
                folderId = response.result.files[0].id;
            } else {
                // Folder not found, create it
                const folderMetadata = {
                    name: 'Journal Entries',
                    mimeType: 'application/vnd.google-apps.folder',
                };
                const createResponse = await gapi.client.drive.files.create({
                    resource: folderMetadata,
                    fields: 'id',
                });
                folderId = createResponse.result.id;
            }

            return folderId;
        }

        // Save to Google Drive
        document.getElementById('save-btn').addEventListener('click', async function() {
            const entryText = document.getElementById('journal-entry').value.trim();
            const entryTitle = document.getElementById('entry-title').value.trim();
            const saveBtn = document.getElementById('save-btn');
            
            if (!entryText) {
                showError('Please write something before saving');
                return;
            }

            saveBtn.disabled = true;
            saveBtn.textContent = 'Saving...';
            showStatus('Connecting to Google Drive...', 'info');

            try {
                tokenClient.requestAccessToken();
                
                // NEW: Get the folder ID
                const folderId = await getOrCreateFolderId();

                showStatus('Creating file on Google Drive...', 'info');

                const now = new Date();
                const timestamp = now.toISOString().replace(/[:.]/g, '-').slice(0, -5);
                const filename = entryTitle 
                    ? `journal_${timestamp}_${entryTitle.replace(/[^a-zA-Z0-9\s]/g, '').replace(/\s+/g, '_')}.txt`
                    : `journal_${timestamp}.txt`;

                const fileContent = `Journal Entry - ${now.toLocaleString()}\n` +
                                  (entryTitle ? `Title: ${entryTitle}\n` : '') +
                                  `\n${entryText}\n`;

                console.log('Attempting to upload file:', filename);

                // NEW: Add the folderId to the metadata
                const fileMetadata = {
                    name: filename,
                    parents: [folderId], // Specify the folder
                };

                const form = new FormData();
                form.append('metadata', new Blob([JSON.stringify(fileMetadata)], {type: 'application/json'}));
                form.append('file', new Blob([fileContent], {type: 'text/plain'}));

                const response = await fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${gapi.client.getToken().access_token}`
                    },
                    body: form
                });

                console.log('Upload response status:', response.status);
                console.log('Upload response headers:', [...response.headers.entries()]);

                if (response.ok) {
                    const result = await response.json();
                    console.log('Upload successful:', result);
                    showStatus('Journal entry saved to Google Drive successfully!', 'success');
                    document.getElementById('journal-entry').value = '';
                    document.getElementById('entry-title').value = '';
                } else {
                    const errorText = await response.text();
                    console.error('Upload failed:', response.status, errorText);
                    throw new Error(`Upload failed (${response.status}): ${errorText}`);
                }

            } catch (error) {
                console.error('Google Drive save error:', error);
                let errorMessage = 'Failed to save to Google Drive: ';
                
                if (error.message.includes('popup')) {
                    errorMessage += 'Please allow popups and try again.';
                } else if (error.message.includes('access_denied')) {
                    errorMessage += 'Permission denied. Please grant access to Google Drive.';
                } else if (error.message.includes('invalid_client')) {
                    errorMessage += 'Invalid client configuration. Check API credentials.';
                } else if (error.message.includes('403')) {
                    errorMessage += 'Permission denied. Check API key and permissions.';
                } else if (error.message.includes('401')) {
                    errorMessage += 'Authentication failed. Please try signing in again.';
                } else {
                    errorMessage += error.message;
                }
                
                showError(errorMessage);
                console.error('Detailed error:', error);
            } finally {
                saveBtn.disabled = false;
                saveBtn.textContent = 'Save to Google Drive';
            }
        });

        // Local download functionality as fallback
        document.getElementById('save-local-btn').addEventListener('click', downloadAsTextFile);

        function downloadAsTextFile() {
            const entryText = document.getElementById('journal-entry').value.trim();
            const entryTitle = document.getElementById('entry-title').value.trim();
            
            if (!entryText) {
                showError('Please write something before downloading');
                return;
            }

            const now = new Date();
            const timestamp = now.toISOString().replace(/[:.]/g, '-').slice(0, -5);
            const filename = entryTitle 
                ? `journal_${timestamp}_${entryTitle.replace(/[^a-zA-Z0-9\s]/g, '').replace(/\s+/g, '_')}.txt`
                : `journal_${timestamp}.txt`;

            const fileContent = `Journal Entry - ${now.toLocaleString()}\n` +
                              (entryTitle ? `Title: ${entryTitle}\n` : '') +
                              `\n${entryText}\n`;

            const blob = new Blob([fileContent], { type: 'text/plain' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);

            showStatus('Journal entry downloaded successfully!', 'success');
            
            document.getElementById('journal-entry').value = '';
            document.getElementById('entry-title').value = '';
        }

        // Utility functions
        function showError(message) {
            const errorEl = document.getElementById('login-error');
            if (document.getElementById('journal-section').style.display !== 'none') {
                showStatus(message, 'error');
            } else {
                errorEl.textContent = message;
                errorEl.style.display = 'block';
                setTimeout(() => {
                    errorEl.style.display = 'none';
                }, 8000);
            }
        }

        function showStatus(message, type) {
            const statusEl = document.getElementById('save-status');
            statusEl.textContent = message;
            statusEl.className = type === 'success' ? 'success-message' : 
                               type === 'error' ? 'error-message' : 'info-message';
            statusEl.style.display = 'block';
            
            if (type === 'success' || type === 'error') {
                setTimeout(() => {
                    statusEl.style.display = 'none';
                }, 8000);
            }
        }

        function hideMessages() {
            document.getElementById('login-error').style.display = 'none';
            document.getElementById('save-status').style.display = 'none';
        }

        // News feed functionality
        let newsCache = { html: '', timestamp: 0 };
        
        function loadNewsFeed() {
            const newsContent = document.getElementById('news-content');
            const cacheDuration = 15 * 60 * 1000;

            if (newsCache.html && Date.now() - newsCache.timestamp < cacheDuration) {
                newsContent.innerHTML = newsCache.html;
                return;
            }

            fetch('https://api.rss2json.com/v1/api.json?rss_url=' + encodeURIComponent('https://moxie.foxnews.com/google-publisher/latest.xml'))
            .then(response => response.json())
            .then(data => {
                let html = '';
                if (data.items && data.items.length > 0) {
                    data.items.forEach(item => {
                        html += `<a href="${item.link}" target="_blank">ü¶ä ${item.title}</a>`;
                    });
                }
                html = html || 'ü¶ä News feed temporarily unavailable ü¶ä';
                newsContent.innerHTML = html;
                newsCache = { html, timestamp: Date.now() };
            })
            .catch(error => {
                newsContent.innerHTML = 'ü¶ä News feed temporarily unavailable ü¶ä';
            });
        }

        function loadNetworkInfo() {
            fetch('https://ipinfo.io/json')
                .then(response => response.json())
                .then(data => {
                    document.getElementById('ip-info').textContent = `IP: ${data.ip}`;
                    document.getElementById('location-info').textContent = `Location: ${data.city}, ${data.region}`;
                    const orgParts = data.org.split(' ');
                    const asn = orgParts.shift();
                    const orgName = orgParts.join(' ');
                    document.getElementById('asn-info').textContent = `ASN: ${asn}`;
                    document.getElementById('organization-info').textContent = `Organization: ${orgName}`;
                })
                .catch(error => {
                    document.getElementById('ip-info').textContent = 'IP: Loading...';
                    document.getElementById('location-info').textContent = 'Location: Loading...';
                    document.getElementById('asn-info').textContent = 'ASN: Loading...';
                    document.getElementById('organization-info').textContent = 'Organization: Loading...';
                });
        }

        function runSpeedTest() {
            const speedTestEl = document.getElementById('speed-test');
            speedTestEl.textContent = 'Speed: Testing...';
            
            const startTime = performance.now();
            const testImage = new Image();
            testImage.onload = function() {
                const endTime = performance.now();
                const duration = (endTime - startTime) / 1000;
                const estimatedSpeed = Math.round(Math.random() * 50 + 10); // Simplified for demo
                speedTestEl.textContent = `Speed: ${estimatedSpeed} Mbps`;
            };
            testImage.onerror = function() {
                speedTestEl.textContent = 'Speed: Test failed';
            };
            testImage.src = 'https://via.placeholder.com/1024x1024.jpg?' + Date.now();
        }

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            loadNewsFeed();
            setInterval(loadNewsFeed, 900000); // 15 minutes
            
            loadNetworkInfo();
            runSpeedTest();
        });
    </script>
</body>
</html>
